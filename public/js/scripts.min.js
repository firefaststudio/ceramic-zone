const themeToggle=document.getElementById("theme-toggle");async function loadNews(){const e=document.getElementById("news-list"),t=document.getElementById("news-grid");if(e||t)try{const n=await fetch("/api/news",{headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}`);const r=await n.json(),s=Array.isArray(r.items)?r.items:Array.isArray(r)?r:[];if(e&&renderNews(e,s),t){t.innerHTML="";const e=document.createDocumentFragment();s.forEach(t=>{const n=document.createElement("article");n.className="card reveal",n.innerHTML=`\n          <h3 class="card__title">${escapeHTML(t.title||"Aggiornamento")}</h3>\n          <p class="card__subtitle">${escapeHTML(t.subtitle||t.excerpt||"")}</p>\n          <p>${escapeHTML(t.summary||t.excerpt||"")}</p>\n          <div class="card__actions">\n            <a href="${escapeAttr(t.url||"#")}" class="btn btn--ghost" target="_blank">Leggi</a>\n          </div>\n        `,e.appendChild(n)}),t.appendChild(e)}}catch(n){e&&renderNews(e,[],n),t&&(t.innerHTML="<p>Impossibile caricare le novit√† al momento.</p>"),console.error("Errore caricamento news:",n)}}function renderNews(e,t,n){if(e.innerHTML="",n)return void(e.innerHTML='\n      <article class="card">\n        <h3>Errore di caricamento</h3>\n        <p class="error">Impossibile caricare le novit√†. Riprova pi√π tardi.</p>\n      </article>');if(!t.length)return void(e.innerHTML='\n      <article class="card">\n        <h3>Nessuna novit√†</h3>\n        <p>Torni a trovarci presto: stiamo preparando aggiornamenti importanti.</p>\n      </article>');const r=document.createDocumentFragment();t.forEach(e=>{const t=document.createElement("a");t.className="card card-news",t.href=e.url||"#",t.href&&!t.href.startsWith("#")&&(t.target="_blank",t.rel="noopener"),t.innerHTML=`\n      <figure class="media">\n        ${e.image?`<img src="${escapeAttr(e.image)}" alt="" loading="lazy">`:""}\n      </figure>\n      <h3>${escapeHTML(e.title||"Aggiornamento")}</h3>\n      <p class="excerpt">${escapeHTML(e.excerpt||"")}</p>\n      <div class="meta">\n        <time datetime="${escapeAttr(e.date||"")}">${formatDate(e.date)}</time>\n        <span class="spacer"></span>\n        <span class="cta">Leggi</span>\n      </div>\n    `,r.appendChild(t)}),e.appendChild(r)}function formatDate(e){return(e?new Date(e):new Date).toLocaleDateString("it-IT",{year:"numeric",month:"long",day:"numeric"})}function escapeHTML(e){return String(e||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function escapeAttr(e){return String(e||"").replaceAll('"',"&quot;")}!function(){try{"dark"===localStorage.getItem("theme")&&document.body.classList.add("dark-mode"),themeToggle&&(themeToggle.textContent=document.body.classList.contains("dark-mode")?"‚òÄÔ∏è":"üåô"),themeToggle&&themeToggle.setAttribute("aria-pressed",document.body.classList.contains("dark-mode"))}catch(e){}}(),document.addEventListener("DOMContentLoaded",()=>{try{loadNews()}catch(e){}}),(()=>{try{const e=document.querySelectorAll(".reveal, .reveal-stagger");if(!e||0===e.length)return;const t=new IntersectionObserver((e,t)=>{for(const n of e)n.isIntersecting&&(n.target.classList.add("is-visible"),t.unobserve(n.target))},{threshold:.12});e.forEach(e=>t.observe(e))}catch(e){}})(),function(){try{const e=document.querySelectorAll(".fade-in-up");if(!e||0===e.length)return;const t=new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.add("animate"),t.unobserve(e.target))})},{threshold:.12});e.forEach(e=>t.observe(e))}catch(e){}}();let __news_offset=0;const __news_limit=3;let __news_category="all",__news_query="",__news_sort="date_desc";function savePreferences(){try{const e={category:__news_category,query:__news_query,sort:__news_sort};localStorage.setItem("newsPrefs",JSON.stringify(e))}catch(e){}}function loadPreferences(){try{const e=localStorage.getItem("newsPrefs");if(!e)return;const t=JSON.parse(e);__news_category=t.category||"all",__news_query=t.query||"",__news_sort=t.sort||"date_desc"}catch(e){}}async function loadNewsChunk(e=!1){const t=document.getElementById("news-grid"),n=document.getElementById("load-more");if(t)try{e&&(__news_offset=0,showSkeletons(3),n&&(n.style.display="inline-flex"));const r=new URLSearchParams({limit:String(3),offset:String(__news_offset)});__news_category&&"all"!==__news_category&&r.set("category",__news_category),__news_query&&r.set("q",__news_query),__news_sort&&r.set("sort",__news_sort);const s=await fetch(`/api/news?${r.toString()}`);if(!s.ok)throw new Error(`HTTP ${s.status}`);const a=await s.json(),c=Array.isArray(a)?a:Array.isArray(a.items)?a.items:[],o=document.createDocumentFragment();c.forEach(e=>{const t=document.createElement("article");t.className="card-neo reveal",t.setAttribute("role","article");const n=e.image?`<img src="${escapeAttr(e.image)}" alt="${escapeHTML(e.title||"Immagine dell'articolo")}" loading="lazy" width="400" height="240">`:"",r=e.category?`<span class="card-neo__badge">${escapeHTML(e.category)}</span>`:"",s=escapeAttr(e.url||"#"),a=s&&!s.startsWith("#")&&!s.startsWith(window.location.origin);t.innerHTML=`\n        <div class="card-neo__image">\n          ${n}\n          ${r}\n        </div>\n        <div class="card-neo__body">\n          <h3 class="card-neo__title">${escapeHTML(e.title||"Aggiornamento")}</h3>\n          <p class="card-neo__excerpt">${escapeHTML(e.excerpt||e.summary||"")}</p>\n          <div class="card-neo__actions">\n            <a href="${s}" class="card-neo__btn" ${a?'target="_blank" rel="noopener"':""} aria-label="Apri: ${escapeHTML(e.title||"Articolo")}">Leggi</a>\n          </div>\n        </div>\n      `,o.appendChild(t)}),t.innerHTML="",t.appendChild(o),__news_offset+=c.length,c.length<3&&n&&(n.style.display="none")}catch(e){console.error("Errore caricamento news chunk:",e),document.getElementById("news-grid")&&(document.getElementById("news-grid").innerHTML="<p>Impossibile caricare le novit√† al momento.</p>")}}function showSkeletons(e=3){const t=document.getElementById("news-grid");if(t){t.innerHTML="";for(let n=0;n<e;n++){const e=document.createElement("div");e.className="card",e.innerHTML='\n      <div class="skeleton skeleton-title"></div>\n      <div class="skeleton skeleton-text"></div>\n      <div class="skeleton skeleton-text"></div>\n    ',t.appendChild(e)}}}function updateSortIndicator(){const e=document.getElementById("sort-indicator");e&&(e.textContent={date_desc:" (pi√π recenti)",date_asc:" (pi√π vecchie)",popularity:" (pi√π popolari)"}[__news_sort]||"")}document.addEventListener("DOMContentLoaded",()=>{try{loadPreferences();const e=document.querySelector(`#news-filters button[data-category="${__news_category}"]`);e&&(document.querySelectorAll("#news-filters button").forEach(e=>e.classList.remove("active")),e.classList.add("active"));const t=document.getElementById("news-search");t&&(t.value=__news_query||"");const n=document.getElementById("news-sort");n&&(n.value=__news_sort||"date_desc"),updateSortIndicator(),document.getElementById("news-grid")&&loadNewsChunk(!0);const r=document.getElementById("load-more");r&&r.addEventListener("click",()=>{loadNewsChunk(),savePreferences()});const s=document.getElementById("news-filters");s&&s.addEventListener("click",e=>{const t=e.target.closest("button[data-category]");t&&(s.querySelectorAll("button").forEach(e=>e.classList.remove("active")),t.classList.add("active"),__news_category=String(t.dataset.category||"all"),savePreferences(),loadNewsChunk(!0))});const a=document.getElementById("news-search");if(a){const e=function(e,t){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}(()=>{__news_query=a.value.trim(),savePreferences(),loadNewsChunk(!0)},300);a.addEventListener("input",e)}const c=document.getElementById("news-sort");c&&c.addEventListener("change",e=>{__news_sort=String(e.target.value||"date_desc"),savePreferences(),updateSortIndicator(),loadNewsChunk(!0)});const o=document.getElementById("news-sentinel");if(o&&"IntersectionObserver"in window){new IntersectionObserver(e=>{e[0].isIntersecting&&loadNewsChunk()},{rootMargin:"200px"}).observe(o)}}catch(e){}});